function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}import UAParser from"ua-parser-js";var includes=function(e,t){return-1!==e.indexOf(t)},isType=function(e){return function(t){return includes(t,e)}},isScript=isType(".js"),isStyle=isType(".css"),isImage=function(e){return["png","jpg","gif","jpeg","webp"].some(function(t){return isType(t)(e)})&&!["//pr.map.qq.com","//hm.baidu.com"].some(function(t){return includes(e,t)})},isFont=function(e){return["eot","ttf","woff","woff2","svg"].some(function(t){return isType(t)(e)})},isJsonp=function(e){return includes(e,"output=jsonp")},toFixed=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return e?+e.toFixed(t):0},byteToKb=function(e){return e?toFixed(e/Math.pow(2,10)):0},xhrSend=function(e,t){var n=new XMLHttpRequest;n.open("POST",e,!1),n.send(t)},getResPerfData=function(e){var t=e.initiatorType,n=e.name,r=e.domainLookupStart,o=e.domainLookupEnd,i=e.connectStart,a=e.connectEnd,s=e.requestStart,c=e.responseStart,u=e.responseEnd,d=e.transferSize,p={"资源路径":n,"DNS 查找耗时":toFixed(o-r),"建立 TCP 连接耗时":toFixed(a-i),"请求到响应耗时":toFixed(c-s),"请求到响应完成耗时":toFixed(u-s)};void 0!==d&&(p["资源体积"]=byteToKb(d));var f="other";switch(t){case"link":f=isScript(n)?"javascript":isStyle(n)?"css":isImage(n)?"image":isFont(n)?"font":"other";break;case"img":f=isImage(n)?"image":"other";break;case"script":f=isJsonp(n)?"api":"javascript";break;case"css":f=isImage(n)?"image":isFont(n)?"font":"other";break;case"fetch":case"beacon":case"xmlhttprequest":f="api"}return p["资源类型"]=f,p},getNavigationTiming=function(){var e={},t=window.performance.getEntriesByType("navigation");if(!t||!t.length)return e;var n=t[0],r=n.domainLookupStart,o=n.domainLookupEnd,i=n.connectStart,a=n.connectEnd,s=n.requestStart,c=n.responseStart,u=n.responseEnd,d=n.transferSize,p=n.domContentLoadedEventEnd,f=n.domComplete;void 0!==d&&(e["资源体积"]=byteToKb(d)),e["DNS 查找耗时"]=toFixed(o-r),e["建立 TCP 连接耗时"]=toFixed(a-i),e["请求到响应耗时"]=toFixed(c-s),e["请求到响应完成耗时"]=toFixed(u-s),e["白屏时间"]=toFixed(p),e["加载完成时间"]=toFixed(f);var g=window.performance.getEntriesByType("paint");if(g.length){var m=g.find(function(e){return"first-contentful-paint"===e.name});m&&(e["白屏时间"]=toFixed(m.startTime))}return e},getResourceTiming=function(){var e=window.performance.getEntriesByType("resource");return e&&e.length?e.reduce(function(e,t){return _toConsumableArray(e).concat([getResPerfData(t)])},[]):[]},getExtraInfo=function(){var e=new UAParser,t=e.getBrowser(),n=e.getOS();return{"浏览器类型":t.name,"浏览器版本":t.version,"系统类型":n.name,"系统版本":n.version}},logData=function(e){var t=JSON.stringify(e),n="https://easy-mock.com/mock/5940f4a28ac26d795f00537d/example/logging";"sendBeacon"in navigator?window.navigator.sendBeacon(n,t)||xhrSend(n,t):xhrSend(n,t)},init=function(e){var t=e.project,n=e.version;if(window.performance&&window.performance.getEntriesByType){var r=Date.now();window.addEventListener("unload",function(){logData({project:t,version:n,timestamp:r,device:getExtraInfo(),resource:getResourceTiming(),navigation:getNavigationTiming()})},!1)}};export{init};
